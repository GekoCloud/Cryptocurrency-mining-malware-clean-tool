#!/bin/bash

# Rename wget and curl to avoid new malware downloads
mv /usr/bin/wget /usr/bin/wget.bak
mv /usr/bin/curl /usr/bin/curl.bak

# Delete known_hosts to avoid propagation via ssh key pair connection
rm -f  /root/.ssh/known_hosts

# We use /root directory because /tmp will be deleted to
cd /root

# Download busybox to execute the following cleaning scripts
curl.bak https://busybox.net/downloads/binaries/1.30.0-i686/busybox > /bin/busybox
chmod +x /bin/busybox

# Download removal script tools from https://git.laucyun.com/laucyun repository. Thanks Laucyun! :)
wget.bak https://git.laucyun.com/security/lsd_malware_clean_tool/raw/master/clear_kerberods.sh
wget.bak https://git.laucyun.com/security/lsd_malware_clean_tool/raw/master/clear_watchdogs.sh
wget.bak https://git.laucyun.com/security/lsd_malware_clean_tool/raw/master/clear_kthrotlds.sh
chmod +x clear_*

# Execute all the script to remove these three possible malware variants
./clear_kerberods.sh
./clear_kthrotlds.sh
./clear_watchdogs.sh

# Kill ./crun executable installed by malware software
kill -9  $(ps aux | grep crun | grep -v 'grep crun' | awk '{print $2;}')

# Stop and clean netdns malware binary
service netdns stop
rm -rf /etc/init.d/netdns

# Killing possible running infection threads
pkill -9 curl
pkill -9 wget
pkill -9 sleep
pkill -9 migrationds

# Kill possible watchbog process (depending on the type of infection)
pkill -9 watchbog
rm -f /bin/watchbog /bin/cpu.txt /bin/config.txt /bin/httpntp /bin/ftpsdns /bin/pools.txt /bin/config.json

# Cleaning again all cron and anacron entries
rm -f /var/spool/cron/crontabs/root
rm -f /var/spool/cron/root
rm -rf /etc/cron.*/oanacroane
rm -rf /etc/cron.d/apache
rm -rf /etc/cron.d/system
rm -rf /etc/cron.d/root
rm -rf /etc/crontab
rm -rf /tmp/*
rm -rf /tmp/.*

echo "Please, reboot the system and check if the clean has been successful!"
